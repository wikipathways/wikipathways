***************
*** 198,211 ****
  			# Update schema if required
  			if ( $row->ss_total_pages == -1 && !$this->mViews ) {
  				$dbr = wfGetDB( DB_SLAVE, array( 'SpecialStatistics', 'vslow') );
! 				list( $page, $user ) = $dbr->tableNamesN( 'page', 'user' );
  
  				$sql = "SELECT COUNT(page_namespace) AS total FROM $page";
  				$res = $dbr->query( $sql, $fname );
  				$pageRow = $dbr->fetchObject( $res );
  				$pages = $pageRow->total + $this->mPages;
  
! 				$sql = "SELECT COUNT(user_id) AS total FROM $user";
  				$res = $dbr->query( $sql, $fname );
  				$userRow = $dbr->fetchObject( $res );
  				$users = $userRow->total + $this->mUsers;
--- 198,214 ----
  			# Update schema if required
  			if ( $row->ss_total_pages == -1 && !$this->mViews ) {
  				$dbr = wfGetDB( DB_SLAVE, array( 'SpecialStatistics', 'vslow') );
! 
!                                 //AP20071027: counting only non-blocked users
! 				list( $page, $user, $ipblocks ) = $dbr->tableNamesN( 'page', 'user', 'ipblocks' );
  
  				$sql = "SELECT COUNT(page_namespace) AS total FROM $page";
  				$res = $dbr->query( $sql, $fname );
  				$pageRow = $dbr->fetchObject( $res );
  				$pages = $pageRow->total + $this->mPages;
  
!                                 //AP20071027: counting only non-blocked users
!                                 $sql = "SELECT COUNT(user_id) AS total FROM $user LEFT JOIN $ipblocks ON user_id=ipb_user WHERE ipb_id IS NULL ";
  				$res = $dbr->query( $sql, $fname );
  				$userRow = $dbr->fetchObject( $res );
  				$users = $userRow->total + $this->mUsers;
